import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'firebase_options.dart';
import 'dart:math' as math;
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:flutter_dotenv/flutter_dotenv.dart';

// 繧ｯ繧､繧ｺ蝠城｡後ョ繝ｼ繧ｿ
const QUIZ_QUESTIONS = {
  'vocabulary': [
    {
      'question':
          'The board of directors will ____ the proposed merger at the next meeting.',
      'options': ['review', 'revise', 'reveal', 'resume'],
      'answer': 0,
      'explanation': '縲梧､懆ｨ弱☆繧九∝・隱ｿ譟ｻ縺吶ｋ縲阪→縺・≧諢丞袖縺ｮreview縺梧枚閼医↓譛繧る←縺励※縺・∪縺吶・
    },
    {
      'question':
          'Please ensure that all ____ for travel expenses are submitted by Friday.',
      'options': [
        'reimbursements',
        'installments',
        'subscriptions',
        'foundations'
      ],
      'answer': 0,
      'explanation':
          '縲梧鴛縺・綾縺励∫ｲｾ邂励阪ｒ諢丞袖縺吶ｋreimbursements縺後∝・蠑ｵ邨瑚ｲｻ・・ravel expenses・峨→縺・≧譁・ц縺ｫ蜷医＞縺ｾ縺吶・
    },
    {
      'question':
          'The marketing team is looking for a more ____ approach to reach younger customers.',
      'options': ['reliable', 'innovative', 'vacant', 'manual'],
      'answer': 1,
      'explanation': '縲碁擠譁ｰ逧・↑縲阪→縺・≧諢丞袖縺ｮinnovative縺後∵眠縺励＞鬘ｧ螳｢螻､縺ｸ縺ｮ繧｢繝励Ο繝ｼ繝√→縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'Employees are encouraged to ____ in the upcoming professional development workshop.',
      'options': ['collaborate', 'participate', 'contribute', 'distribute'],
      'answer': 1,
      'explanation': 'participate in縺ｧ縲後懊↓蜿ょ刈縺吶ｋ縲阪→縺・≧螳壼梛陦ｨ迴ｾ縺ｫ縺ｪ繧翫∪縺吶・
    },
    {
      'question':
          'The new software has significantly ____ our workflow and productivity.',
      'options': ['increased', 'expanded', 'enhanced', 'prolonged'],
      'answer': 2,
      'explanation': '縲鯉ｼ郁ｳｪ繧・・蜉帙ｒ・蛾ｫ倥ａ繧九∝髄荳翫＆縺帙ｋ縲阪→縺・≧諢丞袖縺ｮenhanced縺後√Ρ繝ｼ繧ｯ繝輔Ο繝ｼ繧・函逕｣諤ｧ縺ｫ蟇ｾ縺励※菴ｿ繧上ｌ縺ｾ縺吶・
    },
    {
      'question':
          "The company's ____ performance has exceeded all expectations this fiscal year.",
      'options': ['financial', 'delicate', 'spacious', 'temporary'],
      'answer': 0,
      'explanation': '縲瑚ｲ｡蜍吶・縲・≡驫ｭ逧・↑縲阪→縺・≧諢丞袖縺ｮfinancial縺後∵･ｭ邵ｾ・・erformance・峨ｒ菫ｮ鬟ｾ縺吶ｋ縺ｮ縺ｫ驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          'Ms. Lee was ____ for her outstanding contribution to the successful project.',
      'options': ['notified', 'commended', 'persuaded', 'requested'],
      'answer': 1,
      'explanation':
          '縲瑚､偵ａ繧峨ｌ縺溘∬｡ｨ蠖ｰ縺輔ｌ縺溘阪→縺・≧諢丞袖縺ｮcommended縺後∬ｲ｢迪ｮ・・ontribution・峨↓蟇ｾ縺吶ｋ隧穂ｾ｡縺ｨ縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'The ____ of the contract will be negotiated by the legal department next week.',
      'options': ['terms', 'margins', 'versions', 'portions'],
      'answer': 0,
      'explanation': '縲鯉ｼ亥･醍ｴ・↑縺ｩ縺ｮ・画擅莉ｶ縲阪ｒ諢丞袖縺吶ｋterms縺悟･醍ｴ・ｼ・ontract・峨・譁・ц縺ｧ繧医￥菴ｿ繧上ｌ縺ｾ縺吶・
    },
    {
      'question':
          'Our technical support team is available ____ to assist with any urgent issues.',
      'options': ['briefly', 'cautiously', 'round-the-clock', 'strictly'],
      'answer': 2,
      'explanation': '縲・4譎る俣菴灘宛縺ｧ縲∽ｼ代∩縺ｪ縺上阪ｒ諢丞袖縺吶ｋround-the-clock縺後し繝昴・繝医・蜿ｯ逕ｨ諤ｧ繧定｡ｨ縺励∪縺吶・
    },
    {
      'question':
          'The CEO decided to ____ the opening of the new branch due to budget constraints.',
      'options': ['postpone', 'predict', 'prevent', 'permit'],
      'answer': 0,
      'explanation': '縲悟ｻｶ譛溘☆繧九阪ｒ諢丞袖縺吶ｋpostpone縺後∽ｺ育ｮ励・蛻ｶ邏・↓繧医ｋ髢句ｺ励・驕・ｌ繧定ｪｬ譏弱☆繧九・縺ｫ驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          'All passengers are reminded to keep their personal ____ with them at all times.',
      'options': ['belongings', 'properties', 'ingredients', 'appliances'],
      'answer': 0,
      'explanation': '縲梧戟縺｡迚ｩ縲∵園謖∝刀縲阪ｒ諢丞袖縺吶ｋbelongings縺後い繝翫え繝ｳ繧ｹ縺ｪ縺ｩ縺ｧ荳闊ｬ逧・↓菴ｿ繧上ｌ縺ｾ縺吶・
    },
    {
      'question':
          'The new security policy will ____ effect starting next Monday morning.',
      'options': ['take', 'make', 'give', 'do'],
      'answer': 0,
      'explanation': 'take effect縺ｧ縲鯉ｼ域ｳ募ｾ九ｄ隕丞援縺鯉ｼ牙柑蜉帙ｒ逋ｺ縺吶ｋ縲∝ｮ滓命縺輔ｌ繧九阪→縺・≧諷｣逕ｨ陦ｨ迴ｾ縺ｧ縺吶・
    },
    {
      'question':
          'We need to find a ____ solution to this recurring technical problem.',
      'options': ['permanent', 'preliminary', 'previous', 'partial'],
      'answer': 0,
      'explanation': '縲梧ｰｸ邯夂噪縺ｪ縲∵￡荵・噪縺ｪ縲阪→縺・≧諢丞袖縺ｮpermanent縺後∫ｹｰ繧願ｿ斐＠襍ｷ縺薙ｋ蝠城｡後∈縺ｮ蟇ｾ遲悶→縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          "The annual report provides a ____ overview of the company's global operations.",
      'options': ['comprehensive', 'competitive', 'confidential', 'compatible'],
      'answer': 0,
      'explanation':
          '縲悟桁諡ｬ逧・↑縲∝ｺ・ｯ・峇縺ｫ繧上◆繧九阪→縺・≧諢丞袖縺ｮcomprehensive縺後∝・菴灘ワ・・verview・峨・菫ｮ鬟ｾ縺ｫ驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          'Please ____ the attached document for more details regarding the itinerary.',
      'options': ['consult', 'conduct', 'convey', 'convert'],
      'answer': 0,
      'explanation': '縲鯉ｼ郁ｳ・侭縺ｪ縺ｩ繧抵ｼ牙盾辣ｧ縺吶ｋ縲∬ｪｿ縺ｹ繧九阪→縺・≧諢丞袖縺ｮconsult縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'The hiring manager is looking for a candidate with ____ experience in international sales.',
      'options': ['substantial', 'suspicious', 'subjective', 'superficial'],
      'answer': 0,
      'explanation': '縲後°縺ｪ繧翫・縲∫嶌蠖薙↑縲阪→縺・≧諢丞袖縺ｮsubstantial縺後∫ｵ碁ｨ薙・雎雁ｯ後＆繧定｡ｨ縺咎圀縺ｫ菴ｿ繧上ｌ縺ｾ縺吶・
    },
    {
      'question':
          'The city council has ____ the proposal to build a new community center.',
      'options': ['approved', 'appealed', 'appeared', 'applied'],
      'answer': 0,
      'explanation': '縲梧価隱阪☆繧九∬ｪ榊庄縺吶ｋ縲阪→縺・≧諢丞袖縺ｮapproved縺梧署譯茨ｼ・roposal・峨↓蟇ｾ縺吶ｋ蜍戊ｩ槭→縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'The workshop will help employees ____ their communication skills in professional settings.',
      'options': ['refine', 'repeat', 'restore', 'replace'],
      'answer': 0,
      'explanation': '縲鯉ｼ域橿陦薙↑縺ｩ繧抵ｼ臥｣ｨ縺上∵ｴ礼ｷｴ縺輔○繧九阪→縺・≧諢丞袖縺ｮrefine縺後せ繧ｭ繝ｫ蜷台ｸ翫↓驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          "Mr. Kim's ____ to the project was crucial to its successful completion.",
      'options': ['commitment', 'compliance', 'compliment', 'component'],
      'answer': 0,
      'explanation': '縲檎鍵霄ｫ縲∫・蠢・↑蜿悶ｊ邨・∩縲阪ｒ諢丞袖縺吶ｋcommitment縺後√・繝ｭ繧ｸ繧ｧ繧ｯ繝医・謌仙粥隕∝屏縺ｨ縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'The hotel offers a ____ shuttle service to and from the airport for all guests.',
      'options': ['complimentary', 'mandatory', 'voluntary', 'secondary'],
      'answer': 0,
      'explanation': '縲檎┌譁吶・縲∝━蠕・・縲阪→縺・≧諢丞袖縺ｮcomplimentary縺後し繝ｼ繝薙せ縺ｮ譁・ц縺ｧ鬆ｻ蜃ｺ縺励∪縺吶・
    },
    {
      'question':
          'The survey results indicate that customer ____ has improved significantly this year.',
      'options': ['satisfaction', 'calculation', 'preparation', 'obligation'],
      'answer': 0,
      'explanation': '縲梧ｺ雜ｳ・亥ｺｦ・峨阪ｒ諢丞袖縺吶ｋsatisfaction縺後∬ｪｿ譟ｻ邨先棡・・urvey results・峨・蜀・ｮｹ縺ｨ縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'All employees must ____ with the new safety regulations to avoid potential fines.',
      'options': ['comply', 'rely', 'apply', 'supply'],
      'answer': 0,
      'explanation': 'comply with縺ｧ縲鯉ｼ郁ｦ丞援繧・ｳ募ｾ九↓・牙ｾ薙≧縲・・螳医☆繧九阪→縺・≧驥崎ｦ√↑繝薙ず繝阪せ陦ｨ迴ｾ縺ｧ縺吶・
    },
    {
      'question':
          'The company is seeking to ____ its operations into the emerging Southeast Asian market.',
      'options': ['expand', 'exceed', 'exert', 'expel'],
      'answer': 0,
      'explanation': '縲鯉ｼ井ｺ区･ｭ縺ｪ縺ｩ繧抵ｼ画僑螟ｧ縺吶ｋ縲∝ｺ・￡繧九阪ｒ諢丞袖縺吶ｋexpand縺後ン繧ｸ繝阪せ縺ｮ謌宣聞縺ｮ譁・ц縺ｫ驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          'The ____ of the new office building is expected to be completed by December.',
      'options': ['construction', 'consumption', 'connection', 'conversation'],
      'answer': 0,
      'explanation': '縲悟ｻｺ險ｭ縲阪ｒ諢丞袖縺吶ｋconstruction縺後∝ｻｺ迚ｩ・・uilding・峨′螳梧・縺吶ｋ縺薙→縺ｮ隱ｬ譏弱→縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'Please ____ that all lights and electronic devices are turned off before leaving.',
      'options': ['ensure', 'endure', 'enlarge', 'enrich'],
      'answer': 0,
      'explanation': '縲後懊ｒ遒ｺ螳溘↓縺吶ｋ縲∫｢ｺ隱阪☆繧九阪→縺・≧諢丞袖縺ｮensure縺後∵ｳｨ諢丞繭襍ｷ縺ｮ譁・ц縺ｧ菴ｿ繧上ｌ縺ｾ縺吶・
    },
    {
      'question':
          'The primary ____ of the meeting is to discuss the budget for the next quarter.',
      'options': ['purpose', 'portion', 'process', 'purchase'],
      'answer': 0,
      'explanation': '縲檎岼逧・阪ｒ諢丞袖縺吶ｋpurpose縺後∽ｼ夊ｭｰ縺ｮ隴ｰ鬘後ｒ隱ｬ譏弱☆繧九・縺ｫ驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          'The maintenance team is currently ____ the faulty ventilation system.',
      'options': ['repairing', 'repeating', 'regarding', 'revealing'],
      'answer': 0,
      'explanation': '縲御ｿｮ逅・☆繧九阪ｒ諢丞袖縺吶ｋrepairing縺後∵腐髫懊＠縺滂ｼ・aulty・峨す繧ｹ繝・Β縺ｸ縺ｮ蟇ｾ蜃ｦ縺ｨ縺励※驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'The new social media strategy has proven to be highly ____ in increasing brand awareness.',
      'options': ['effective', 'effort', 'effect', 'efficiently'],
      'answer': 0,
      'explanation': '縲悟柑譫懃噪縺ｪ縲阪ｒ諢丞袖縺吶ｋ蠖｢螳ｹ隧枡ffective縺後∵姶逡･・・trategy・峨・隧穂ｾ｡縺ｨ縺励※驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          '____ her hard work and dedication, Ms. Sato was promoted to senior manager.',
      'options': ['Due to', 'Regardless of', 'Instead of', 'As for'],
      'answer': 0,
      'explanation': '縲後懊・縺溘ａ縺ｫ縲√懊′蜴溷屏縺ｧ縲阪→縺・≧逅・罰繧定｡ｨ縺僖ue to縺梧・騾ｲ縺ｮ逅・罰繧定ｪｬ譏弱☆繧九・縺ｫ驕ｩ縺励※縺・∪縺吶・
    },
    {
      'question':
          'The guest speaker gave an ____ presentation on the future of renewable energy.',
      'options': ['insightful', 'internal', 'inferior', 'initial'],
      'answer': 0,
      'explanation': '縲梧ｴ槫ｯ溷鴨縺ｮ縺ゅｋ縲・撼蟶ｸ縺ｫ譛臥寢縺ｪ縲阪→縺・≧諢丞袖縺ｮinsightful縺後√・繝ｬ繧ｼ繝ｳ繝・・繧ｷ繝ｧ繝ｳ縺ｮ隧穂ｾ｡縺ｨ縺励※驕ｩ蛻・〒縺吶・
    },
  ],
  'grammar': [
    {
      'question':
          'The marketing director is ____ in the new advertising campaign proposed by the agency.',
      'options': ['interest', 'interesting', 'interested', 'interestingly'],
      'answer': 2,
      'explanation':
          'be interested in・医懊↓闊亥袖縺後≠繧具ｼ峨→縺・≧蠖｢縺ｫ縺ｪ繧翫∪縺吶ゆｺｺ縺御ｸｻ隱槭・蝣ｴ蜷医・縲・℃蜴ｻ蛻・ｩ槫ｽ｢interested・郁・蜻ｳ繧呈戟縺｣縺ｦ縺・ｋ迥ｶ諷具ｼ峨ｒ菴ｿ縺・∪縺吶・
    },
    {
      'question':
          '____ the inclement weather, the outdoor corporate retreat will proceed as scheduled.',
      'options': ['Despite', 'Although', 'Nevertheless', 'Even though'],
      'answer': 0,
      'explanation':
          '遨ｺ謇蠕後・the inclement weather縺ｯ蜷崎ｩ槫唱縺ｪ縺ｮ縺ｧ縲∝燕鄂ｮ隧槭・Despite・医懊↓繧ゅ°縺九ｏ繧峨★・峨′驕ｩ蛻・〒縺吶・lthough縺ｨEven though縺ｯ謗･邯夊ｩ槭↑縺ｮ縺ｧ蠕後ｍ縺ｫS+V縺檎ｶ壹″縺ｾ縺吶・
    },
    {
      'question':
          'Ms. Tanaka ____ for this law firm for over ten years before she was promoted to partner.',
      'options': ['works', 'is working', 'has worked', 'had worked'],
      'answer': 3,
      'explanation': '驕主悉縺ｮ縺ゅｋ譎らせ・・as promoted・峨ｈ繧翫ｂ蜑阪・譛滄俣繧定｡ｨ縺吶◆繧√・℃蜴ｻ螳御ｺ・ｽ｢縺ｮhad worked縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'The final report must ____ to the department head by the end of the business day.',
      'options': ['submit', 'be submitted', 'submitting', 'be submitting'],
      'answer': 1,
      'explanation': '荳ｻ隱槭・The final report縺ｯ謠仙・縺輔ｌ繧句・縺ｪ縺ｮ縺ｧ縲∝女蜍墓・縺ｮbe submitted縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'The technician ____ fixed the server issue was highly praised by the IT manager.',
      'options': ['who', 'which', 'whom', 'whose'],
      'answer': 0,
      'explanation':
          '遨ｺ謇縺ｮ蠕後ｍ縺ｫ蜍戊ｩ枅ixed縺檎ｶ壹＞縺ｦ縺・ｋ縺溘ａ縲∝・陦瑚ｩ杁he technician・井ｺｺ・峨ｒ菫ｮ鬟ｾ縺吶ｋ荳ｻ譬ｼ縺ｮ髢｢菫ゆｻ｣蜷崎ｩ檜ho縺悟ｿ・ｦ√〒縺吶・
    },
    {
      'question':
          'The CEO decided to prepare the keynote speech for the annual conference ____.',
      'options': ['he', 'his', 'him', 'himself'],
      'answer': 3,
      'explanation': '縲靴EO閾ｪ霄ｫ縺ｧ縲阪→縺・≧諢丞袖縺ｫ縺吶ｋ縺溘ａ縲∝・蟶ｰ莉｣蜷崎ｩ槭・himself繧貞ｼｷ隱ｿ縺ｨ縺励※菴ｿ縺・∪縺吶・
    },
    {
      'question':
          'The research team worked ____ to complete the study before the international deadline.',
      'options': ['hard', 'hardly', 'hardness', 'hardest'],
      'answer': 0,
      'explanation':
          '縲御ｸ逕滓・蜻ｽ縺ｫ縲阪→縺・≧諢丞袖縺ｮ蜑ｯ隧柯ard縺碁←蛻・〒縺吶Ｉardly縺ｯ縲後⊇縺ｨ繧薙←縲懊↑縺・阪→縺・≧蜷ｦ螳壹・諢丞袖縺ｫ縺ｪ縺｣縺ｦ縺励∪縺・∪縺吶・
    },
    {
      'question':
          'The strategic planning meeting is scheduled to take place ____ Monday morning at 9:00 A.M.',
      'options': ['in', 'at', 'on', 'by'],
      'answer': 2,
      'explanation': '譖懈律繧・音螳壹・譌･莉假ｼ・onday morning・峨・蜑阪↓縺ｯ蜑咲ｽｮ隧柞n繧剃ｽｿ縺・∪縺吶・
    },
    {
      'question':
          'If I ____ you, I would double-check the financial figures before presenting them.',
      'options': ['am', 'was', 'were', 'been'],
      'answer': 2,
      'explanation':
          '莉ｮ螳壽ｳ暮℃蜴ｻ縺ｮ譁・ｼ・f + 荳ｻ隱・+ 驕主悉蠖｢, 荳ｻ隱・+ would + 蜴溷ｽ｢・峨〒縺吶Ｃe蜍戊ｩ槭・荳ｻ隱槭↓髢｢繧上ｉ縺嗹ere繧堤畑縺・ｋ縺ｮ縺御ｸ闊ｬ逧・〒縺吶・
    },
    {
      'question':
          'The management team suggested ____ the merger until the next fiscal quarter.',
      'options': ['postpone', 'to postpone', 'postponing', 'postponed'],
      'answer': 2,
      'explanation': 'suggest縺ｯ蜍募錐隧橸ｼ・ing・峨ｒ逶ｮ逧・ｪ槭↓蜿悶ｋ蜍戊ｩ槭〒縺吶Ｕo荳榊ｮ夊ｩ槭・蜿悶ｊ縺ｾ縺帙ｓ縲・
    },
    {
      'question':
          'It is essential that every employee ____ the new security protocols immediately.',
      'options': ['follow', 'follows', 'followed', 'following'],
      'answer': 0,
      'explanation':
          'essential・井ｸ榊庄谺縺ｪ・峨↑縺ｩ縺ｮ蠖｢螳ｹ隧槭↓邯壹￥that遽蜀・〒縺ｯ縲∝虚隧槭・蜴溷ｽ｢・医∪縺溘・should + 蜴溷ｽ｢・峨↓縺ｪ繧翫∪縺呻ｼ井ｻｮ螳壽ｳ慕樟蝨ｨ・峨・
    },
    {
      'question':
          "This year's quarterly profits are significantly ____ than those of the previous year.",
      'options': ['high', 'higher', 'highest', 'highly'],
      'answer': 1,
      'explanation': '豈碑ｼ・ｯｾ雎｡繧定｡ｨ縺冲han縺後≠繧九◆繧√∵ｯ碑ｼ・ｴ壹・higher縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'We will have the local contractor ____ the air conditioning system in the warehouse.',
      'options': ['repair', 'repairs', 'repaired', 'to repair'],
      'answer': 0,
      'explanation': 'have + 莠ｺ + 蜴溷ｽ｢荳榊ｮ夊ｩ槭〒縲鯉ｼ井ｺｺ・峨↓縲懊＠縺ｦ繧ゅｉ縺・ｼ井ｽｿ蠖ｹ・峨阪→縺・≧讒矩縺ｫ縺ｪ繧翫∪縺吶・
    },
    {
      'question':
          'By the time the new manager arrives next week, we ____ the orientation materials.',
      'options': [
        'finish',
        'will finish',
        'will have finished',
        'have finished'
      ],
      'answer': 2,
      'explanation':
          'By the time + 迴ｾ蝨ｨ蠖｢・域悴譚･縺ｮ莉｣逕ｨ・峨′縺ゅｋ蝣ｴ蜷医∵悴譚･縺ｮ縺ゅｋ譎らせ縺ｧ縺ｮ螳御ｺ・ｒ陦ｨ縺呎悴譚･螳御ｺ・ｽ｢・・ill have finished・峨ｒ菴ｿ縺・∪縺吶・
    },
    {
      'question':
          'The cost of raw materials has ____ significantly over the past six months.',
      'options': ['rose', 'risen', 'raised', 'raising'],
      'answer': 1,
      'explanation': '縲御ｸ翫′繧九阪→縺・≧閾ｪ蜍戊ｩ柮ise縺ｮ驕主悉蛻・ｩ槫ｽ｢risen縺碁←蛻・〒縺吶Ｓaise縺ｯ縲後懊ｒ荳翫￡繧九阪→縺・≧莉門虚隧槭〒縺吶・
    },
    {
      'question':
          'Neither the department head ____ the staff members were informed about the office relocation.',
      'options': ['or', 'and', 'nor', 'but'],
      'answer': 2,
      'explanation': 'Neither A nor B・・繧・繧ゅ懊↑縺・ｼ峨→縺・≧逶ｸ髢｢謗･邯夊ｩ槭・螳壼梛陦ｨ迴ｾ縺ｧ縺吶・
    },
    {
      'question':
          'Please note that the responsibility for maintaining the office equipment is ____.',
      'options': ['your', 'you', 'yours', 'yourself'],
      'answer': 2,
      'explanation': '縲後≠縺ｪ縺溘・繧ゅ・・医≠縺ｪ縺溘・雋ｬ莉ｻ・峨阪→縺・≧諢丞袖縺ｮ謇譛我ｻ｣蜷崎ｩ框ours縺悟ｿ・ｦ√〒縺吶Ｚour縺ｯ蠕後ｍ縺ｫ蜷崎ｩ槭′蠢・ｦ√〒縺吶・
    },
    {
      'question':
          'The new headquarters is located conveniently ____ the subway station and the bus terminal.',
      'options': ['among', 'between', 'from', 'against'],
      'answer': 1,
      'explanation':
          'between A and B・・縺ｨB縺ｮ髢難ｼ峨→縺・≧陦ｨ迴ｾ縺後・縺､縺ｮ蝣ｴ謇・・ubway station縺ｨbus terminal・峨・髢薙↓菴咲ｽｮ縺吶ｋ縺薙→繧堤､ｺ縺励∪縺吶・
    },
    {
      'question':
          '____ by the sudden drop in stock prices, the investors called for an emergency meeting.',
      'options': ['Surprising', 'Surprise', 'Surprised', 'To surprise'],
      'answer': 2,
      'explanation': '蛻・ｩ樊ｧ区枚縺ｧ縺吶よ兜雉・ｮｶ縺後碁ｩ壹°縺輔ｌ縺溘阪→縺・≧蜿怜虚縺ｮ諢丞袖縺ｫ縺ｪ繧九◆繧√・℃蜴ｻ蛻・ｩ朶urprised縺ｧ蟋九ａ縺ｾ縺吶・
    },
    {
      'question':
          'It was ____ great honor to receive the Employee of the Year award last night.',
      'options': ['a', 'an', 'the', 'any'],
      'answer': 0,
      'explanation':
          'honor縺ｯ謨ｰ縺医ｉ繧後ｋ蜷崎ｩ槭→縺励※謇ｱ繧上ｌ縲√％縺薙〒縺ｯ縲御ｸ縺､縺ｮ蜈画・↑縺薙→縲阪→縺励※荳榊ｮ壼・隧杪繧堤畑縺・∪縺呻ｼ・reat縺ｮ鬆ｭ譁・ｭ励′蟄宣浹縺ｮ縺溘ａ・峨・
    },
    {
      'question':
          'The company purchased new ____ for the laboratory to improve testing efficiency.',
      'options': ['equipments', 'equipment', 'equipping', 'equipped'],
      'answer': 1,
      'explanation': 'equipment縺ｯ荳榊庄邂怜錐隧橸ｼ域焚縺医ｉ繧後↑縺・錐隧橸ｼ峨↑縺ｮ縺ｧ縲∬､・焚蠖｢縺ｮs繧偵▽縺代★縺ｫ逕ｨ縺・∪縺吶・
    },
    {
      'question':
          'The executive assistant is known for organizing international conferences very ____.',
      'options': ['good', 'well', 'best', 'better'],
      'answer': 1,
      'explanation': '蜍戊ｩ柞rganizing繧剃ｿｮ鬟ｾ縺吶ｋ縺溘ａ縺ｫ縺ｯ蜑ｯ隧槭・well縺悟ｿ・ｦ√〒縺吶Ｈood縺ｯ蠖｢螳ｹ隧槭〒縺吶・
    },
    {
      'question':
          'The regional office is located in a district ____ several major tech companies are based.',
      'options': ['which', 'where', 'what', 'whose'],
      'answer': 1,
      'explanation': '蜈郁｡瑚ｩ杪 district・亥ｴ謇・峨ｒ菫ｮ鬟ｾ縺励∝ｾ後ｍ縺ｫ螳悟・縺ｪ譁・′邯壹＞縺ｦ縺・ｋ縺溘ａ縲・未菫ょ憶隧檜here縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'Mr. Lopez ____ to Europe three times this year to negotiate the distribution contracts.',
      'options': ['goes', 'is going', 'has been', 'was'],
      'answer': 2,
      'explanation': '縲御ｻ雁ｹｴ3蝗櫁｡後▲縺ｦ縺・ｋ・育ｵ碁ｨ難ｼ峨阪ｒ陦ｨ縺吶◆繧√∫樟蝨ｨ螳御ｺ・ｽ｢縺ｮhas been縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'The primary objective of this seminar is ____ employees on the new software features.',
      'options': ['train', 'to train', 'trained', 'trains'],
      'answer': 1,
      'explanation': '縲檎岼逧・・縲懊☆繧九％縺ｨ縺ｧ縺吶阪→縺・≧陬懆ｪ槭・蠖ｹ蜑ｲ繧呈棡縺溘☆荳榊ｮ夊ｩ柎o train縺碁←蛻・〒縺吶・
    },
    {
      'question':
          'The public relations officer is responsible ____ handling all media inquiries.',
      'options': ['to', 'with', 'for', 'in'],
      'answer': 2,
      'explanation': 'be responsible for・医懊↓雋ｬ莉ｻ縺後≠繧九√懊ｒ諡・ｽ薙＠縺ｦ縺・ｋ・峨→縺・≧驥崎ｦ∫・隱槭〒縺吶・
    },
    {
      'question':
          'Please remain seated ____ the flight attendant announces that it is safe to move around.',
      'options': ['during', 'until', 'while', 'since'],
      'answer': 1,
      'explanation':
          '縲後懊∪縺ｧ縺壹▲縺ｨ・育ｶ咏ｶ夲ｼ峨阪→縺・≧諢丞袖縺ｮ謗･邯夊ｩ柆ntil縺碁←蛻・〒縺吶Ｅuring縺ｯ蜑咲ｽｮ隧槭↑縺ｮ縺ｧ蠕後ｍ縺ｫS+V縺ｯ鄂ｮ縺代∪縺帙ｓ縲・
    },
    {
      'question':
          'The ultimate ____ of the project depends on the cooperation between all departments.',
      'options': ['succeed', 'success', 'successful', 'successfully'],
      'answer': 1,
      'explanation': '蜀隧杁he縺ｨ蜑咲ｽｮ隧柞f縺ｮ髢薙↓縺ｯ蜷崎ｩ槭′蠢・ｦ√〒縺吶Ｔuccess・域・蜉滂ｼ峨′驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'Employees ____ smoke within 20 meters of the building\'s main entrance.',
      'options': ['must not', 'do not have to', 'might not', 'not'],
      'answer': 0,
      'explanation': '縲後懊＠縺ｦ縺ｯ縺・￠縺ｪ縺・ｼ育ｦ∵ｭ｢・峨阪→縺・≧諢丞袖縺ｮmust not縺後ン繧ｸ繝阪せ繝ｫ繝ｼ繝ｫ縺ｮ譁・ц縺ｧ驕ｩ蛻・〒縺吶・
    },
    {
      'question':
          'This is the ____ expensive marketing campaign the company has ever launched.',
      'options': ['more', 'most', 'much', 'mostly'],
      'answer': 1,
      'explanation': 'ever・医％繧後∪縺ｧ縺ｧ・峨→縺・≧陦ｨ迴ｾ縺後≠繧九◆繧√∵怙荳顔ｴ壹・the most expensive縺碁←蛻・〒縺吶・
    },
  ],
  'reading': [
    {
      'question':
          '[Email] Subject: Project Meeting. Dear Team, our meeting scheduled for Tuesday at 2 PM has been moved to Wednesday at 10 AM in Room 302. Please update your calendars. Question: When is the new meeting time?',
      'options': [
        'Tuesday at 2 PM',
        'Tuesday at 10 AM',
        'Wednesday at 2 PM',
        'Wednesday at 10 AM'
      ],
      'answer': 3,
      'explanation': '譛ｬ譁・↓縲稽oved to Wednesday at 10 AM・域ｰｴ譖懊・蜊亥燕10譎ゅ↓螟画峩縺輔ｌ縺滂ｼ峨阪→縺ゅｊ縺ｾ縺吶・
    },
    {
      'question':
          '[Notice] The office will be closed on Monday, September 4, for the Labor Day holiday. Regular hours will resume on Tuesday. Question: Why will the office be closed?',
      'options': [
        'For maintenance',
        'For a public holiday',
        'For a staff retreat',
        'For a renovation'
      ],
      'answer': 1,
      'explanation': '縲掲or the Labor Day holiday・亥感蜒崎・・譌･縺ｮ逾晄律縺ｮ縺溘ａ・峨阪→髢蛾事縺ｮ逅・罰縺瑚ｿｰ縺ｹ繧峨ｌ縺ｦ縺・∪縺吶・
    },
    {
      'question':
          '[Ad] Graphic Designer wanted. Must have 3+ years of experience and proficiency in Adobe Creative Suite. Send your portfolio to jobs@design.com. Question: What is a requirement for this position?',
      'options': [
        'A degree in marketing',
        'Fluency in Spanish',
        'Experience with Adobe software',
        'Own transportation'
      ],
      'answer': 2,
      'explanation':
          '縲継roficiency in Adobe Creative Suite・・dobe繝・・繝ｫ縺ｮ鄙堤・・峨阪′隕∽ｻｶ縺ｨ縺励※謖吶￡繧峨ｌ縺ｦ縺・∪縺吶・
    },
    {
      'question':
          '[Shipping Update] Your order #4552 has been shipped and is expected to arrive within 3-5 business days. Track your package using the link below. Question: How long will the delivery take?',
      'options': ['1-2 days', '3-5 days', '7-10 days', 'Two weeks'],
      'answer': 1,
      'explanation':
          '縲径rrive within 3-5 business days・・縲・蝟ｶ讌ｭ譌･莉･蜀・↓蛻ｰ逹莠亥ｮ夲ｼ峨阪→險倩ｼ峨＆繧後※縺・∪縺吶・
    },
    {
      'question':
          '[Memo] To reduce electricity costs, all employees are requested to turn off their computer monitors and office lights before leaving. Question: What is the purpose of this memo?',
      'options': [
        'To improve security',
        'To save energy',
        'To update software',
        'To clean the office'
      ],
      'answer': 1,
      'explanation':
          '縲卦o reduce electricity costs・磯崕豌嶺ｻ｣繧貞炎貂帙☆繧九◆繧・ｼ峨阪√▽縺ｾ繧顔怐繧ｨ繝搾ｼ・ave energy・峨′逶ｮ逧・〒縺吶・
    },
    {
      'question':
          '[Product Info] The X-2000 vacuum cleaner comes with a 2-year warranty covering all parts and labor. Return it within 30 days for a full refund. Question: How long is the warranty period?',
      'options': ['30 days', '1 year', '2 years', '5 years'],
      'answer': 2,
      'explanation': '縲径 2-year warranty・・蟷ｴ髢薙・菫晁ｨｼ・峨阪→譏手ｨ倥＆繧後※縺・∪縺吶・
    },
    {
      'question':
          '[Business News] Global Tech Corp announced it will acquire StartUp Inc for \$50 million to expand its cloud computing services. Question: What is the goal of the acquisition?',
      'options': [
        'To hire more staff',
        'To lower prices',
        'To expand services',
        'To close a branch'
      ],
      'answer': 2,
      'explanation':
          '縲荊o expand its cloud computing services・医け繝ｩ繧ｦ繝峨し繝ｼ繝薙せ繧呈僑螟ｧ縺吶ｋ縺溘ａ・峨阪→逶ｮ逧・′譖ｸ縺九ｌ縺ｦ縺・∪縺吶・
    },
    {
      'question':
          '[Conference Schedule] 9:00 AM: Registration; 10:00 AM: Keynote by Dr. Aris; 11:30 AM: Workshop. Question: What happens at 10:00 AM?',
      'options': [
        'Registration begins',
        'Lunch break',
        'A workshop',
        'A keynote speech'
      ],
      'answer': 3,
      'explanation': '縲・0:00 AM: Keynote・亥渕隱ｿ隰帶ｼ費ｼ峨阪→繧ｹ繧ｱ繧ｸ繝･繝ｼ繝ｫ縺ｫ縺ゅｊ縺ｾ縺吶・
    },
    {
      'question':
          '[Store Hours] Monday-Friday: 9 AM - 9 PM. Saturday: 10 AM - 6 PM. Sunday: Closed. Question: When does the store close on Saturdays?',
      'options': ['6 PM', '9 PM', '10 AM', 'It is closed'],
      'answer': 0,
      'explanation': '縲郡aturday: 10 AM - 6 PM縲阪ｈ繧翫・哩蠎玲凾髢薙・蜊亥ｾ・譎ゅ〒縺吶・
    },
    {
      'question':
          '[Email] Hi Sarah, I\'ve attached the invoice for the last shipment. Please process the payment by Friday. Thanks, Mark. Question: What did Mark send to Sarah?',
      'options': [
        'A shipping label',
        'A payment check',
        'A billing document',
        'A product catalog'
      ],
      'answer': 2,
      'explanation':
          '縲径ttached the invoice・郁ｫ区ｱよ嶌繧呈ｷｻ莉倥＠縺滂ｼ峨阪→縺ゅｊ縺ｾ縺吶Ｊnvoice縺ｯbilling document・郁ｫ区ｱよ嶌鬘橸ｼ峨・荳遞ｮ縺ｧ縺吶・
    },
    {
      'question':
          '[Notice] All visitors must sign in at the front desk and wear a visitor\'s badge at all times while in the building. Question: What are visitors required to do?',
      'options': [
        'Make an appointment',
        'Register at the desk',
        'Wait in the car',
        'Show a passport'
      ],
      'answer': 1,
      'explanation': '縲茎ign in at the front desk・亥女莉倥〒鄂ｲ蜷阪☆繧具ｼ剰ｨ伜ｸｳ縺吶ｋ・峨阪→縺・≧謖・､ｺ縺後≠繧翫∪縺吶・
    },
    {
      'question':
          '[Ad] Special Offer: Book your flight by the end of the month and get a 20% discount on all international routes. Question: How can a customer get a discount?',
      'options': [
        'By flying locally',
        'By booking early',
        'By joining a club',
        'By traveling in a group'
      ],
      'answer': 1,
      'explanation':
          '縲沓ook... by the end of the month・井ｻ頑怦譛ｫ縺ｾ縺ｧ縺ｫ莠育ｴ・☆繧具ｼ峨阪→縺・≧譛滄剞蜀・・莠育ｴ・ｼ域掠繧√・莠育ｴ・ｼ峨′譚｡莉ｶ縺ｧ縺吶・
    },
    {
      'question':
          '[Memo] Starting next month, we will implement a new flexible work policy allowing staff to work from home two days a week. Question: What change is being announced?',
      'options': [
        'A pay raise',
        'A new office location',
        'Remote work options',
        'A longer lunch break'
      ],
      'answer': 2,
      'explanation': '縲詣ork from home・亥惠螳・共蜍呻ｼ峨阪√▽縺ｾ繧翫Μ繝｢繝ｼ繝医Ρ繝ｼ繧ｯ縺ｮ驕ｸ謚櫁い縺ｫ縺､縺・※霑ｰ縺ｹ縺ｦ縺・∪縺吶・
    },
    {
      'question':
          '[Review] The food at Bistro 5 was excellent, but the service was quite slow. We waited 40 minutes for our main course. Question: What did the reviewer dislike?',
      'options': [
        'The food quality',
        'The prices',
        'The location',
        'The waiting time'
      ],
      'answer': 3,
      'explanation':
          '縲茎ervice was quite slow・医し繝ｼ繝薙せ縺後°縺ｪ繧企≦縺九▲縺滂ｼ峨阪→蠕・■譎る俣・・aiting time・峨↓荳肴ｺ繧堤､ｺ縺励※縺・∪縺吶・
    },
    {
      'question':
          '[Itinerary] Flight BA202 departs London at 8:00 AM and arrives in New York at 11:00 AM local time. Question: Where is the flight\'s destination?',
      'options': ['London', 'New York', 'Paris', 'Tokyo'],
      'answer': 1,
      'explanation': '縲径rrives in New York・医ル繝･繝ｼ繝ｨ繝ｼ繧ｯ縺ｫ蛻ｰ逹縺吶ｋ・峨阪→縺ゅｋ縺ｮ縺ｧ縲∫岼逧・慍縺ｯ繝九Η繝ｼ繝ｨ繝ｼ繧ｯ縺ｧ縺吶・
    },
    {
      'question':
          '[Policy] Employees are entitled to 15 days of paid vacation per year after completing one year of service. Question: When can an employee take 15 days of vacation?',
      'options': [
        'Immediately',
        'After six months',
        'After one year',
        'After two years'
      ],
      'answer': 2,
      'explanation':
          '縲径fter completing one year of service・・蟷ｴ髢薙・蜍､蜍吶ｒ邨ゅ∴縺溷ｾ鯉ｼ峨阪→譚｡莉ｶ縺檎､ｺ縺輔ｌ縺ｦ縺・∪縺吶・
    },
    {
      'question':
          '[Sign] Caution: Wet Floor. Please use the alternative entrance near the cafeteria. Question: Where should people enter?',
      'options': [
        'Through the main door',
        'Near the cafeteria',
        'Through the garage',
        'The back gate'
      ],
      'answer': 1,
      'explanation':
          '縲蛍se the alternative entrance near the cafeteria・医き繝輔ぉ繝・Μ繧｢霑代￥縺ｮ蛻･縺ｮ蜈･蜿｣繧剃ｽｿ縺｣縺ｦ縺上□縺輔＞・峨阪→謖・､ｺ縺輔ｌ縺ｦ縺・∪縺吶・
    },
    {
      'question':
          '[Email] Dear Customer, your subscription to Finance Monthly will expire on Oct 31. Renew now to avoid interruption. Question: What is the purpose of the email?',
      'options': [
        'To offer a job',
        'To confirm an order',
        'To remind about a deadline',
        'To announce a sale'
      ],
      'answer': 2,
      'explanation': '雉ｼ隱ｭ譛滄剞・・xpire on Oct 31・峨′霑代▼縺・※縺・ｋ縺薙→繧堤衍繧峨○縲∵峩譁ｰ繧剃ｿ・☆繝ｪ繝槭う繝ｳ繝峨Γ繝ｼ繝ｫ縺ｧ縺吶・
    },
    {
      'question':
          '[Press Release] Green Energy Ltd will open a new manufacturing plant in Ohio, creating 200 local jobs. Question: What will happen in Ohio?',
      'options': [
        'A factory will close',
        'A new facility will open',
        'A protest will occur',
        'A school will be built'
      ],
      'answer': 1,
      'explanation':
          '縲経pen a new manufacturing plant・域眠縺励＞陬ｽ騾蟾･蝣ｴ繧帝幕縺擾ｼ峨阪√▽縺ｾ繧頑眠譁ｽ險ｭ・・acility・峨・髢玖ｨｭ縺ｧ縺吶・
    },
    {
      'question':
          '[Meeting Minutes] Mr. Kim suggested upgrading the server. The board approved the motion and allocated \$10,000 for the project. Question: What did the board agree to do?',
      'options': [
        'Hire Mr. Kim',
        'Spend money on a server',
        'Cancel the project',
        'Move the office'
      ],
      'answer': 1,
      'explanation':
          '繧ｵ繝ｼ繝舌・縺ｮ繧｢繝・・繧ｰ繝ｬ繝ｼ繝峨↓1荳・ラ繝ｫ繧貞牡繧雁ｽ薙※縺滂ｼ・llocated \$10,000・峨％縺ｨ縺九ｉ縲∬ｲｻ逕ｨ繧偵°縺代ｋ縺薙→縺ｫ蜷域э縺励◆縺ｨ蛻・°繧翫∪縺吶・
    },
    {
      'question':
          '[Webpage] Register for our newsletter and receive a coupon for \$10 off your first purchase over \$50. Question: How much must a customer spend to use the coupon?',
      'options': ['\$10', '\$40', '\$50', '\$60'],
      'answer': 2,
      'explanation': '縲継urchase over \$50・・0繝峨Ν莉･荳翫・雉ｼ蜈･・峨阪′繧ｯ繝ｼ繝昴Φ菴ｿ逕ｨ縺ｮ譚｡莉ｶ縺ｧ縺吶・
    },
    {
      'question':
          '[Letter] Dear Mr. Lee, we are pleased to inform you that your application for the loan has been approved. Question: What is the subject of this letter?',
      'options': [
        'A job offer',
        'A bank loan',
        'A tax return',
        'A rental agreement'
      ],
      'answer': 1,
      'explanation':
          '縲径pplication for the loan has been approved・医Ο繝ｼ繝ｳ縺ｮ逕ｳ隲九′謇ｿ隱阪＆繧後◆・峨阪→縺ゅｊ縺ｾ縺吶・
    },
    {
      'question':
          '[Safety Rule] Protective eyewear must be worn at all times while operating the drilling machinery. Question: Who is this rule for?',
      'options': [
        'Office clerks',
        'Machine operators',
        'Delivery drivers',
        'Sales representatives'
      ],
      'answer': 1,
      'explanation':
          '縲詣hile operating the drilling machinery・域侍蜑頑ｩ溘ｒ謫堺ｽ懊☆繧矩俣・峨阪→縺・≧險倩ｿｰ縺九ｉ縲∵ｩ滓｢ｰ縺ｮ菴懈･ｭ閠・′蟇ｾ雎｡縺ｧ縺吶・
    },
    {
      'question':
          '[Ad] Fresh Organic Produce. Locally grown. Open daily from 8 AM to sunset. Located on Highway 12. Question: Where is the market located?',
      'options': [
        'In a shopping mall',
        'On Highway 12',
        'Near the airport',
        'Downtown'
      ],
      'answer': 1,
      'explanation': '縲鍬ocated on Highway 12縲阪→蝣ｴ謇縺梧・險倥＆繧後※縺・∪縺吶・
    },
    {
      'question':
          '[Notice] Due to a broken water pipe, the restrooms on the second floor are temporarily out of order. Please use those on the third floor. Question: Which facilities are unavailable?',
      'options': [
        'The elevators',
        'The cafeteria',
        'The restrooms',
        'The parking lot'
      ],
      'answer': 2,
      'explanation':
          '縲罫estrooms... are temporarily out of order・医ヨ繧､繝ｬ縺ｯ荳譎ら噪縺ｫ菴ｿ逕ｨ荳榊庄・峨阪→縺ゅｊ縺ｾ縺吶・
    },
    {
      'question':
          '[Email] Thank you for your interest in the position. We would like to invite you for an interview this Thursday at 11 AM. Question: What is the sender doing?',
      'options': [
        'Asking for a refund',
        'Scheduling an interview',
        'Rejecting a candidate',
        'Providing a reference'
      ],
      'answer': 1,
      'explanation': '縲景nvite you for an interview・磯擇謗･縺ｫ諡帛ｾ・☆繧具ｼ峨阪→縲・擇謗･縺ｮ莠亥ｮ壹ｒ遶九※繧医≧縺ｨ縺励※縺・∪縺吶・
    },
    {
      'question':
          '[Memo] Staff are reminded that personal phone calls should be kept to a minimum during working hours. Question: What does the memo ask staff to do?',
      'options': [
        'Work more hours',
        'Buy new phones',
        'Limit personal calls',
        'Call more customers'
      ],
      'answer': 2,
      'explanation':
          '縲継ersonal phone calls should be kept to a minimum・育ｧ∫畑髮ｻ隧ｱ縺ｯ譛蟆城剞縺ｫ謚代∴繧九∋縺搾ｼ峨阪→謖・､ｺ縺励※縺・∪縺吶・
    },
    {
      'question':
          '[Contract] This agreement shall remain in effect for a period of three years from the date of signing. Question: How long is the contract valid?',
      'options': ['One year', 'Two years', 'Three years', 'Five years'],
      'answer': 2,
      'explanation': '縲掲or a period of three years・・蟷ｴ髢難ｼ峨阪→譛牙柑譛滄俣縺瑚ｨ倥＆繧後※縺・∪縺吶・
    },
    {
      'question':
          '[Announcement] We are happy to welcome Jane Smith as our new Marketing Director. She previously worked at Media Solutions for 10 years. Question: Where did Jane Smith work before?',
      'options': [
        'At a school',
        'At Media Solutions',
        'In the government',
        'At a bank'
      ],
      'answer': 1,
      'explanation':
          '縲継reviously worked at Media Solutions・井ｻ･蜑阪・Media Solutions縺ｧ蜒阪＞縺ｦ縺・◆・峨阪→縺ゅｊ縺ｾ縺吶・
    },
    {
      'question':
          '[Airport Sign] Flight AF44 is delayed. New departure time: 4:30 PM. Please check the monitors for gate information. Question: What is the status of Flight AF44?',
      'options': ['Canceled', 'On time', 'Delayed', 'Landed'],
      'answer': 2,
      'explanation': '縲熊light AF44 is delayed・・F44萓ｿ縺ｯ驕・ｌ縺ｦ縺・ｋ・峨阪→譏手ｨ倥＆繧後※縺・∪縺吶・
    },
  ],
};
const BADGES = [
  {'id': 1, 'name': 'First Step', 'icon': '箝・, 'need': 1},
  {'id': 2, 'name': '5 Tasks', 'icon': '箝絶ｭ・, 'need': 5},
  {'id': 3, 'name': '10 Tasks', 'icon': '箝絶ｭ絶ｭ・, 'need': 10},
  {'id': 4, 'name': 'Halfway', 'icon': '箝絶ｭ絶ｭ絶ｭ・, 'need': -1},
  {'id': 5, 'name': 'Complete', 'icon': '箝絶ｭ絶ｭ絶ｭ絶ｭ・, 'need': -2},
];

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await dotenv.load(fileName: ".env");
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Lumo TOEIC',
      theme: ThemeData(primarySwatch: Colors.green, useMaterial3: true),
      home: const SplashScreen(),
    );
  }
}

// 繧ｹ繝励Λ繝・す繝･逕ｻ髱｢・医ョ繝ｼ繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ・・
class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});
  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> {
  @override
  void initState() {
    super.initState();
    _checkData();
  }

  Future<void> _checkData() async {
    await Future.delayed(const Duration(milliseconds: 500));
    try {
      final doc = await FirebaseFirestore.instance
          .collection('users')
          .doc('default_user')
          .get();
      if (!mounted) return;

      if (doc.exists && doc.data()?['hasData'] == true) {
        final data = doc.data()!;
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(
            builder: (context) => MountainPathScreen(
              examDate: DateTime.parse(data['examDate']),
              personality: Map<String, String>.from(data['personality'] ?? {}),
              level: data['level'] ?? 'beginner',
            ),
          ),
        );
      } else {
        Navigator.pushReplacement(
            context,
            MaterialPageRoute(
                builder: (context) => const LevelDiagnosisWelcome()));
      }
    } catch (e) {
      if (!mounted) return;
      Navigator.pushReplacement(
          context,
          MaterialPageRoute(
              builder: (context) => const LevelDiagnosisWelcome()));
    }
  }

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      body: Center(child: CircularProgressIndicator()),
    );
  }
}

// 繝ｬ繝吶Ν險ｺ譁ｭWelcome逕ｻ髱｢
class LevelDiagnosisWelcome extends StatelessWidget {
  const LevelDiagnosisWelcome({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
            gradient:
                LinearGradient(colors: [Color(0xFF667EEA), Color(0xFF764BA2)])),
        child: Center(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Container(
              padding: const EdgeInsets.all(32),
              decoration: BoxDecoration(
                  color: Colors.white, borderRadius: BorderRadius.circular(20)),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Text('縺ｾ縺壼ｮ溷鴨繝√ぉ繝・け繧偵＠繧医≧',
                      style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: Colors.black)),
                  const SizedBox(height: 16),
                  const Text('縺ゅ↑縺溘・繝ｬ繝吶Ν縺ｫ蜷医▲縺溷ｭｦ鄙偵・繝ｩ繝ｳ繧剃ｽ懈・縺吶ｋ縺溘ａ縲∫ｰ｡蜊倥↑蝠城｡後ｒ蜃ｺ縺励∪縺吶ょ・8蝠上〒縺吶・,
                      style: TextStyle(fontSize: 15, color: Colors.black87),
                      textAlign: TextAlign.center),
                  const SizedBox(height: 24),
                  ElevatedButton(
                    onPressed: () => Navigator.pushReplacement(
                        context,
                        MaterialPageRoute(
                            builder: (context) => const LevelDiagnosisQuiz())),
                    style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF58CC02),
                        padding: const EdgeInsets.symmetric(
                            horizontal: 32, vertical: 14)),
                    child: const Text('險ｺ譁ｭ繧貞ｧ九ａ繧・,
                        style: TextStyle(
                            fontSize: 17,
                            fontWeight: FontWeight.bold,
                            color: Colors.white)),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// 繝ｬ繝吶Ν險ｺ譁ｭQuiz逕ｻ髱｢
class LevelDiagnosisQuiz extends StatefulWidget {
  const LevelDiagnosisQuiz({super.key});
  @override
  State<LevelDiagnosisQuiz> createState() => _LevelDiagnosisQuizState();
}

class _LevelDiagnosisQuizState extends State<LevelDiagnosisQuiz> {
  List<Map<String, dynamic>> questions = [];
  List<bool> answers = [];
  int currentIndex = 0;
  int? selected;
  bool showAnswer = false;

  @override
  void initState() {
    super.initState();
    // 蜷・Ξ繝吶Ν縺九ｉ2蝠上★縺､
    final levels = [
      {
        'name': '300',
        'questions': [
          {
            'q': 'I ___ a student.',
            'opts': ['am', 'is', 'are', 'be'],
            'ans': 0
          },
          {
            'q': 'She ___ to school every day.',
            'opts': ['go', 'goes', 'going', 'gone'],
            'ans': 1
          },
        ]
      },
      {
        'name': '600',
        'questions': [
          {
            'q': 'If I ___ rich, I would travel the world.',
            'opts': ['am', 'was', 'were', 'be'],
            'ans': 2
          },
          {
            'q': 'The meeting ___ at 3 PM yesterday.',
            'opts': ['starts', 'started', 'will start', 'has started'],
            'ans': 1
          },
        ]
      },
      {
        'name': '800',
        'questions': [
          {
            'q': 'By the time you arrive, I ___ the report.',
            'opts': ['finish', 'finished', 'will finish', 'will have finished'],
            'ans': 3
          },
          {
            'q': '___ the circumstances, we decided to proceed.',
            'opts': ['Despite', 'Although', 'However', 'Because'],
            'ans': 0
          },
        ]
      },
      {
        'name': '900',
        'questions': [
          {
            'q': 'The proposal was met with ___ from the board.',
            'opts': ['skeptical', 'skepticism', 'skeptically', 'skeptic'],
            'ans': 1
          },
          {
            'q': 'Had I known, I ___ differently.',
            'opts': ['act', 'acted', 'would act', 'would have acted'],
            'ans': 3
          },
        ]
      },
    ];
    for (var level in levels) {
      for (var q in (level['questions'] as List)) {
        questions.add({
          'question': q['q'],
          'options': q['opts'],
          'answer': q['ans'],
          'levelName': level['name']
        });
      }
    }
  }

  void handleAnswer() {
    if (selected == null) return;
    final isCorrect = selected == questions[currentIndex]['answer'];
    setState(() {
      showAnswer = true;
      answers.add(isCorrect);
    });
    Future.delayed(const Duration(milliseconds: 1200), () {
      if (currentIndex < questions.length - 1) {
        setState(() {
          currentIndex++;
          selected = null;
          showAnswer = false;
        });
      } else {
        final correctCount = answers.where((a) => a).length;
        final level = correctCount >= 7
            ? 'advanced'
            : correctCount >= 4
                ? 'intermediate'
                : 'beginner';
        final scoreLabel = correctCount >= 7
            ? '800-900轤ｹ繝ｬ繝吶Ν'
            : correctCount >= 4
                ? '600-800轤ｹ繝ｬ繝吶Ν'
                : '300-600轤ｹ繝ｬ繝吶Ν';
        Navigator.pushReplacement(
            context,
            MaterialPageRoute(
                builder: (context) => LevelDiagnosisResult(
                    level: level, scoreLabel: scoreLabel)));
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final q = questions[currentIndex];
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
            gradient:
                LinearGradient(colors: [Color(0xFF667EEA), Color(0xFF764BA2)])),
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            const SizedBox(height: 60),
            const Text('螳溷鴨繝√ぉ繝・け',
                style: TextStyle(
                    color: Colors.white,
                    fontSize: 17,
                    fontWeight: FontWeight.bold)),
            const SizedBox(height: 20),
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.9),
                  borderRadius: BorderRadius.circular(20)),
              child: Column(
                children: [
                  Text('蝠城｡・${currentIndex + 1} / ${questions.length}',
                      style: const TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                          color: Colors.black54)),
                  const SizedBox(height: 12),
                  Text(q['question'],
                      style:
                          const TextStyle(fontSize: 15, color: Colors.black87)),
                  const SizedBox(height: 16),
                  ...List.generate(q['options'].length, (idx) {
                    return GestureDetector(
                      onTap: showAnswer
                          ? null
                          : () => setState(() => selected = idx),
                      child: Container(
                        margin: const EdgeInsets.only(bottom: 8),
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          border: Border.all(
                              color: selected == idx
                                  ? const Color(0xFF58CC02)
                                  : Colors.grey.shade300,
                              width: 2),
                          borderRadius: BorderRadius.circular(8),
                          color: showAnswer
                              ? (idx == q['answer']
                                  ? Colors.green.shade50
                                  : selected == idx
                                      ? Colors.red.shade50
                                      : Colors.white)
                              : selected == idx
                                  ? Colors.grey.shade100
                                  : Colors.white,
                        ),
                        child: Text(q['options'][idx],
                            style: const TextStyle(
                                fontSize: 14, color: Colors.black87)),
                      ),
                    );
                  }),
                  if (showAnswer)
                    Container(
                      margin: const EdgeInsets.only(top: 16),
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                          color: selected == q['answer']
                              ? Colors.green.shade50
                              : Colors.red.shade50,
                          borderRadius: BorderRadius.circular(8)),
                      child: Text(selected == q['answer'] ? '豁｣隗｣' : '荳肴ｭ｣隗｣',
                          style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              color: Colors.black87)),
                    ),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed:
                        (selected == null || showAnswer) ? null : handleAnswer,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: (selected == null || showAnswer)
                          ? Colors.grey
                          : const Color(0xFF58CC02),
                      minimumSize: const Size(double.infinity, 48),
                    ),
                    child: const Text('蝗樒ｭ斐☆繧・,
                        style: TextStyle(
                            fontWeight: FontWeight.bold, color: Colors.white)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// 繝ｬ繝吶Ν險ｺ譁ｭResult逕ｻ髱｢
class LevelDiagnosisResult extends StatelessWidget {
  final String level;
  final String scoreLabel;
  const LevelDiagnosisResult(
      {super.key, required this.level, required this.scoreLabel});

  @override
  Widget build(BuildContext context) {
    final labels = {'beginner': '蛻晉ｴ・, 'intermediate': '荳ｭ邏・, 'advanced': '荳顔ｴ・};
    final colors = {
      'beginner': Colors.blue,
      'intermediate': Colors.orange,
      'advanced': Colors.purple
    };
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
            gradient:
                LinearGradient(colors: [Color(0xFF667EEA), Color(0xFF764BA2)])),
        child: Center(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Container(
              padding: const EdgeInsets.all(32),
              decoration: BoxDecoration(
                  color: Colors.white, borderRadius: BorderRadius.circular(20)),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Text('險ｺ譁ｭ邨先棡',
                      style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: Colors.black)),
                  const SizedBox(height: 16),
                  Text(scoreLabel,
                      style: TextStyle(
                          fontSize: 28,
                          fontWeight: FontWeight.bold,
                          color: colors[level])),
                  const SizedBox(height: 8),
                  Text(labels[level]!,
                      style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Colors.black54)),
                  const SizedBox(height: 24),
                  ElevatedButton(
                    onPressed: () => Navigator.pushReplacement(
                        context,
                        MaterialPageRoute(
                            builder: (context) =>
                                PersonalityTest(level: level))),
                    style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF58CC02),
                        padding: const EdgeInsets.symmetric(
                            horizontal: 32, vertical: 14)),
                    child: const Text('谺｡縺ｸ',
                        style: TextStyle(
                            fontSize: 17,
                            fontWeight: FontWeight.bold,
                            color: Colors.white)),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// 諤ｧ譬ｼ險ｺ譁ｭ
class PersonalityTest extends StatefulWidget {
  final String level;
  const PersonalityTest({super.key, required this.level});
  @override
  State<PersonalityTest> createState() => _PersonalityTestState();
}

class _PersonalityTestState extends State<PersonalityTest> {
  int currentQuestion = 0;
  final Map<String, String> answers = {};
  final List<Map<String, dynamic>> questions = [
    {
      'q': '豈取律豎ｺ縺ｾ縺｣縺滓凾髢薙↓蜍牙ｼｷ縺ｧ縺阪ｋ・・,
      'opts': ['縺ｧ縺阪ｋ', '縺ｧ縺阪↑縺・],
      'key': 'routine'
    },
    {
      'q': '荳蠎ｦ縺ｫ髟ｷ譎る俣髮・ｸｭ縺ｧ縺阪ｋ・・,
      'opts': ['縺ｧ縺阪ｋ', '縺ｧ縺阪↑縺・],
      'key': 'focus'
    },
    {
      'q': '繧ｲ繝ｼ繝諢溯ｦ壹〒蟄ｦ縺ｶ縺ｮ縺悟･ｽ縺搾ｼ・,
      'opts': ['螂ｽ縺・, '闍ｦ謇・],
      'key': 'gamified'
    },
  ];

  void handleAnswer(String answer) {
    setState(() {
      answers[questions[currentQuestion]['key']] = answer;
      if (currentQuestion < questions.length - 1) {
        currentQuestion++;
      } else {
        Navigator.pushReplacement(
            context,
            MaterialPageRoute(
                builder: (context) =>
                    ExamDateInput(personality: answers, level: widget.level)));
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final q = questions[currentQuestion];
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
            gradient:
                LinearGradient(colors: [Color(0xFF667EEA), Color(0xFF764BA2)])),
        child: Center(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Container(
              padding: const EdgeInsets.all(32),
              decoration: BoxDecoration(
                  color: Colors.white, borderRadius: BorderRadius.circular(20)),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text('雉ｪ蝠・${currentQuestion + 1} / ${questions.length}',
                      style:
                          const TextStyle(fontSize: 14, color: Colors.black54)),
                  const SizedBox(height: 16),
                  Text(q['q'],
                      style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Colors.black)),
                  const SizedBox(height: 24),
                  ...q['opts'].map<Widget>((opt) {
                    return Container(
                      margin: const EdgeInsets.only(bottom: 12),
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: () => handleAnswer(opt),
                        style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF58CC02),
                            padding: const EdgeInsets.symmetric(vertical: 16)),
                        child: Text(opt,
                            style: const TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: Colors.white)),
                      ),
                    );
                  }).toList(),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// 蜿鈴ｨ捺律蜈･蜉・
class ExamDateInput extends StatefulWidget {
  final Map<String, String> personality;
  final String level;
  const ExamDateInput(
      {super.key, required this.personality, required this.level});
  @override
  State<ExamDateInput> createState() => _ExamDateInputState();
}

class _ExamDateInputState extends State<ExamDateInput> {
  int selectedYear = DateTime.now().year;
  int selectedMonth = DateTime.now().month;
  int selectedDay = DateTime.now().day;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Text('TOEIC蜿鈴ｨ捺律繧帝∈謚・,
                  style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold)),
              const SizedBox(height: 40),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  _buildDropdown(
                      value: selectedYear,
                      items: List.generate(3, (i) => DateTime.now().year + i),
                      onChanged: (val) => setState(() => selectedYear = val!),
                      suffix: '蟷ｴ'),
                  const SizedBox(width: 16),
                  _buildDropdown(
                      value: selectedMonth,
                      items: List.generate(12, (i) => i + 1),
                      onChanged: (val) => setState(() => selectedMonth = val!),
                      suffix: '譛・),
                  const SizedBox(width: 16),
                  _buildDropdown(
                      value: selectedDay,
                      items: List.generate(31, (i) => i + 1),
                      onChanged: (val) => setState(() => selectedDay = val!),
                      suffix: '譌･'),
                ],
              ),
              const SizedBox(height: 60),
              ElevatedButton(
                onPressed: () {
                  final examDate =
                      DateTime(selectedYear, selectedMonth, selectedDay);
                  Navigator.pushReplacement(
                      context,
                      MaterialPageRoute(
                          builder: (context) => MountainPathScreen(
                              examDate: examDate,
                              personality: widget.personality,
                              level: widget.level)));
                },
                style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.green,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(
                        horizontal: 48, vertical: 16)),
                child: const Text('蜀帝匱繧帝幕蟋具ｼ・, style: TextStyle(fontSize: 18)),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDropdown(
      {required int value,
      required List<int> items,
      required ValueChanged<int?> onChanged,
      required String suffix}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
      decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: Colors.grey.shade300)),
      child: DropdownButton<int>(
          value: value,
          underline: const SizedBox(),
          items: items
              .map((int value) => DropdownMenuItem<int>(
                  value: value, child: Text('$value$suffix')))
              .toList(),
          onChanged: onChanged),
    );
  }
}

// 螻ｱ驕鍋判髱｢・医Γ繧､繝ｳ・・
class MountainPathScreen extends StatefulWidget {
  final DateTime examDate;
  final Map<String, String> personality;
  final String level;
  const MountainPathScreen(
      {super.key,
      required this.examDate,
      required this.personality,
      required this.level});
  @override
  State<MountainPathScreen> createState() => _MountainPathScreenState();
}

List<int> shownBadgeIds = [];
int? popBadgeId;

class _MountainPathScreenState extends State<MountainPathScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final String userId = 'default_user';
  List<Map<String, dynamic>> tasks = [];
  List<bool> tasksCompleted = [];
  List<bool> tasksExpanded = [];
  int currentStreak = 0;
  DateTime? lastCompletedDate;
  int completedCount = 0;
  Map<String, Map<String, int>> quizStats = {
    'vocabulary': {'correct': 0, 'total': 0},
    'grammar': {'correct': 0, 'total': 0},
    'reading': {'correct': 0, 'total': 0},
  };
  int todayCompleted = 0;
  int weekCompleted = 0;
  int monthCompleted = 0;

  @override
  void initState() {
    super.initState();
    Future.delayed(const Duration(milliseconds: 500), () async {
      await _loadData();
      if (tasks.isEmpty) {
        await _generateAISchedule();
      }
    });
  }

  Future<void> _generateAISchedule() async {
    try {
      final apiKey = dotenv.env['GROQ_API_KEY'] ?? '';
      print('API Key loaded: ${apiKey.substring(0, 10)}');
      final diffDays = widget.examDate.difference(DateTime.now()).inDays;
      final level = widget.level;

      final url = Uri.parse('https://api.groq.com/openai/v1/chat/completions');

      final response = await http.post(
        url,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $apiKey',
        },
        body: jsonEncode({
          'model': 'llama-3.3-70b-versatile',
          'messages': [
            {
              'role': 'user',
              'content': '''
TOEIC縺ｮ蟄ｦ鄙偵せ繧ｱ繧ｸ繝･繝ｼ繝ｫ繧剃ｽ懈・縺励※縺上□縺輔＞縲・
繝ｬ繝吶Ν: $level
谿九ｊ譌･謨ｰ: $diffDays譌･
繧ｿ繧ｹ繧ｯ謨ｰ: ${diffDays > 30 ? 30 : diffDays}蛟・

莉･荳九・JSON蠖｢蠑上〒霑斐＠縺ｦ縺上□縺輔＞:
{"tasks": [{"task": "繧ｿ繧ｹ繧ｯ蜷・, "reason": "逅・罰"}]}

繧ｿ繧ｹ繧ｯ蜷阪・縲悟腰隱槫ｭｦ鄙偵阪梧枚豕慕ｷｴ鄙偵阪後Μ繝ｼ繝・ぅ繝ｳ繧ｰ貍皮ｿ偵阪↑縺ｩ繧貞性繧√※縺上□縺輔＞縲・
JSON縺ｮ縺ｿ霑斐＠縺ｦ縺上□縺輔＞縲・
'''
            }
          ],
          'temperature': 0.7,
          'max_tokens': 2000,
        }),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final text = data['choices'][0]['message']['content'] as String;
        final cleanText =
            text.replaceAll('```json', '').replaceAll('```', '').trim();
        final parsed = jsonDecode(cleanText);
        final taskList = parsed['tasks'] as List;
        setState(() {
          tasks = taskList
              .map((t) => {
                    'task': t['task'] as String,
                    'reason': t['reason'] as String,
                  })
              .toList();
          tasksCompleted = List<bool>.filled(tasks.length, false);
          tasksExpanded = List<bool>.filled(tasks.length, false);
        });
        await _saveData();
      } else {
        print('AI schedule error: ${response.statusCode} ${response.body}');
      }
    } catch (e) {
      print('AI schedule error: $e');
    }
  }

  Future<void> _saveData() async {
    try {
      await _firestore.collection('users').doc(userId).set({
        'hasData': true,
        'examDate': widget.examDate.toIso8601String(),
        'personality': widget.personality,
        'level': widget.level,
        'completedCount': completedCount,
        'tasksCompleted': tasksCompleted,
        'shownBadgeIds': shownBadgeIds,
        'currentStreak': currentStreak,
        'lastCompletedDate': lastCompletedDate?.toIso8601String(),
        'quizStats': quizStats,
      });

      // 騾ｱ髢薙Λ繝ｳ繧ｭ繝ｳ繧ｰ逕ｨ
      final now = DateTime.now();
      final weekStart = now.subtract(Duration(days: now.weekday - 1));
      final weekKey =
          '${weekStart.year}-W${weekStart.month.toString().padLeft(2, '0')}-${weekStart.day.toString().padLeft(2, '0')}';

      await _firestore.collection('leaderboard').doc(userId).set({
        'weekKey': weekKey,
        'completedCount': completedCount,
        'updatedAt': FieldValue.serverTimestamp(),
      });
    } catch (e) {
      print('Save error: $e');
    }
  }

  Future<void> _loadData() async {
    try {
      final doc = await _firestore.collection('users').doc(userId).get();
      if (doc.exists && mounted) {
        final data = doc.data();
        if (data != null && data['tasksCompleted'] != null) {
          setState(() {
            final completed = List<bool>.from(data['tasksCompleted']);
            for (int i = 0; i < tasks.length && i < completed.length; i++) {
              tasksCompleted[i] = completed[i];
            }
            completedCount = tasksCompleted.where((t) => t).length;
            shownBadgeIds = List<int>.from(data['shownBadgeIds'] ?? []);
            currentStreak = data['currentStreak'] ?? 0;
            lastCompletedDate = data['lastCompletedDate'] != null
                ? DateTime.parse(data['lastCompletedDate'])
                : null;
            if (data['quizStats'] != null) {
              final stats = Map<String, dynamic>.from(data['quizStats']);
              quizStats = {
                'vocabulary': Map<String, int>.from(
                    stats['vocabulary'] ?? {'correct': 0, 'total': 0}),
                'grammar': Map<String, int>.from(
                    stats['grammar'] ?? {'correct': 0, 'total': 0}),
                'reading': Map<String, int>.from(
                    stats['reading'] ?? {'correct': 0, 'total': 0}),
              };
            }
          });
          _calculateProgress();
        }
      }
    } catch (e) {
      print('Load error: $e');
    }
  }

  void checkNewBadges() {
    final progress =
        tasks.isEmpty ? 0 : (completedCount / tasks.length * 100).round();

    for (var badge in BADGES) {
      final need = badge['need'] as int;
      final badgeId = badge['id'] as int;

      bool earned = false;
      if (need == -1) {
        earned = progress >= 50;
      } else if (need == -2)
        earned = progress == 100;
      else
        earned = completedCount >= need;

      if (earned && !shownBadgeIds.contains(badgeId)) {
        setState(() {
          shownBadgeIds.add(badgeId);
        });
        _saveData();
        // 逶ｴ謗･showDialog繧貞他縺ｶ
        Future.delayed(const Duration(milliseconds: 300), () {
          if (mounted) {
            showDialog(
              context: context,
              barrierDismissible: false,
              builder: (context) => BadgePopup(
                name: badge['name'] as String,
                icon: badge['icon'] as String,
              ),
            );
          }
        });
        break;
      }
    }
  }

  void toggleComplete(int i) {
    if (tasksCompleted[i]) return;

    final task = tasks[i]['task'].toString().toLowerCase();
    String category = 'vocabulary';
    if (task.contains('譁・ｳ・) || task.contains('grammar')) {
      category = 'grammar';
    } else if (task.contains('隱ｭ隗｣') ||
        task.contains('繝ｪ繝ｼ繝・ぅ繝ｳ繧ｰ') ||
        task.contains('reading')) {
      category = 'reading';
    }

    showDialog(
      context: context,
      builder: (context) => QuizModal(
        category: category,
        onComplete: (success, cat) {
          if (success) {
            // 豁｣隗｣邇・ｒ險倬鹸
            quizStats[cat]!['total'] = (quizStats[cat]!['total'] ?? 0) + 1;
            quizStats[cat]!['correct'] = (quizStats[cat]!['correct'] ?? 0) + 1;

            setState(() {
              tasksCompleted[i] = true;
              completedCount = tasksCompleted.where((t) => t).length;
              _updateStreak();
              _calculateProgress();
            });
            print('completedCount: $completedCount');
            print('shownBadgeIds: $shownBadgeIds');
            _saveData();
            checkNewBadges();
          } else {
            // 荳肴ｭ｣隗｣繧りｨ倬鹸
            quizStats[cat]!['total'] = (quizStats[cat]!['total'] ?? 0) + 1;
            _saveData();
          }
        },
      ),
    );
  }

  void _updateStreak() {
    final today = DateTime.now();
    final todayDate = DateTime(today.year, today.month, today.day);

    if (lastCompletedDate == null) {
      // 蛻晏屓
      currentStreak = 1;
      lastCompletedDate = todayDate;
    } else {
      final lastDate = DateTime(
        lastCompletedDate!.year,
        lastCompletedDate!.month,
        lastCompletedDate!.day,
      );
      final diff = todayDate.difference(lastDate).inDays;

      if (diff == 0) {
        // 莉頑律譌｢縺ｫ螳御ｺ・ｸ医∩・井ｽ輔ｂ縺励↑縺・ｼ・
      } else if (diff == 1) {
        // 騾｣邯・
        currentStreak++;
        lastCompletedDate = todayDate;
      } else {
        // 騾泌・繧後◆
        currentStreak = 1;
        lastCompletedDate = todayDate;
      }
    }
  }

  void _calculateProgress() {
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);

    todayCompleted = 0;
    weekCompleted = 0;
    monthCompleted = 0;

    // 莉頑律繝ｻ莉企ｱ繝ｻ莉頑怦縺ｮ繧ｿ繧ｹ繧ｯ螳御ｺ・焚繧偵き繧ｦ繝ｳ繝・
    // 豕ｨ: 莉翫・蜈ｨ繧ｿ繧ｹ繧ｯ繧定ｦ九※繧九′縲∝ｾ後〒譌･莉伜挨縺ｫ蛻・￠繧九∋縺・
    for (int i = 0; i < tasks.length && i < tasksCompleted.length; i++) {
      if (tasksCompleted[i]) {
        todayCompleted++;
        weekCompleted++;
        monthCompleted++;
      }
    }
  }

  Widget _buildCategoryButton(String label, String category, int count) {
    return GestureDetector(
      onTap: () {
        Navigator.pop(context); // 繧ｫ繝・ざ繝ｪ驕ｸ謚槭ｒ髢峨§繧・
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => QuizSessionScreen(
              category: category,
              questionCount: count,
            ),
          ),
        );
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [Color(0xFF5DADE2), Color(0xFF3498DB)],
          ),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              label,
              style: const TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold),
            ),
            Text(
              '$count蝠・,
              style: const TextStyle(color: Colors.white70, fontSize: 14),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final progress =
        tasks.isEmpty ? 0 : (completedCount / tasks.length * 100).round();

    // 繝舌ャ繧ｸ繝昴ャ繝励い繝・・
    if (popBadgeId != null) {
      final badge = BADGES.firstWhere((b) => b['id'] == popBadgeId);
      Future.microtask(() {
        showDialog(
          context: context,
          barrierDismissible: false,
          builder: (context) => BadgePopup(
            name: badge['name'] as String,
            icon: badge['icon'] as String,
          ),
        );
      });
    }

    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(colors: [
            Color(0xFF5DADE2),
            Color(0xFF85C1E9),
            Color(0xFFAED6F1),
            Color(0xFFD5F5E3),
            Color(0xFF7DCEA0)
          ], begin: Alignment.topCenter, end: Alignment.bottomCenter),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // Header
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Row(
                      children: [
                        Icon(Icons.star, color: Colors.white, size: 28),
                        SizedBox(width: 8),
                        Text('Lumo',
                            style: TextStyle(
                                color: Colors.white,
                                fontSize: 22,
                                fontWeight: FontWeight.bold)),
                      ],
                    ),
                    Row(
                      children: [
                        if (currentStreak > 0) ...[
                          const Icon(Icons.local_fire_department,
                              color: Colors.orange, size: 20),
                          const SizedBox(width: 4),
                          Text('$currentStreak譌･騾｣邯・,
                              style: const TextStyle(
                                  color: Colors.white,
                                  fontSize: 14,
                                  fontWeight: FontWeight.bold)),
                          const SizedBox(width: 12),
                        ],
                        Text('$completedCount 繧ｿ繧ｹ繧ｯ螳御ｺ・,
                            style: const TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.bold)),
                        IconButton(
                          icon: const Icon(Icons.leaderboard,
                              color: Colors.white, size: 20),
                          onPressed: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                  builder: (context) =>
                                      const LeaderboardScreen()),
                            );
                          },
                        ),
                        IconButton(
                          icon: const Icon(Icons.refresh,
                              color: Colors.white, size: 20),
                          onPressed: () async {
                            await _firestore
                                .collection('users')
                                .doc(userId)
                                .delete();
                            if (context.mounted) {
                              Navigator.pushReplacement(
                                  context,
                                  MaterialPageRoute(
                                      builder: (context) =>
                                          const SplashScreen()));
                            }
                          },
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              // Progress bar
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: Column(
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        const Text('騾ｲ謐・,
                            style:
                                TextStyle(color: Colors.white, fontSize: 12)),
                        Text('$progress%',
                            style: const TextStyle(
                                color: Colors.white,
                                fontSize: 12,
                                fontWeight: FontWeight.bold)),
                      ],
                    ),
                    const SizedBox(height: 4),
                    Container(
                      height: 10,
                      decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.3),
                          borderRadius: BorderRadius.circular(8)),
                      child: FractionallySizedBox(
                        alignment: Alignment.centerLeft,
                        widthFactor: progress / 100,
                        child: Container(
                            decoration: BoxDecoration(
                                color: const Color(0xFF58CC02),
                                borderRadius: BorderRadius.circular(8))),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 20),
              const SizedBox(height: 20),
// 驕疲・邇・｡ｨ遉ｺ
              Container(
                padding: const EdgeInsets.all(16),
                margin: const EdgeInsets.symmetric(horizontal: 20),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceAround,
                  children: [
                    Column(
                      children: [
                        const Text('莉頑律',
                            style: TextStyle(fontSize: 12, color: Colors.grey)),
                        Text('$todayCompleted/${tasks.length}',
                            style: const TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF333333))),
                      ],
                    ),
                    Column(
                      children: [
                        const Text('莉企ｱ',
                            style: TextStyle(fontSize: 12, color: Colors.grey)),
                        Text('$weekCompleted/${tasks.length}',
                            style: const TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF333333))),
                      ],
                    ),
                    Column(
                      children: [
                        const Text('莉頑怦',
                            style: TextStyle(fontSize: 12, color: Colors.grey)),
                        Text('$monthCompleted/${tasks.length} ',
                            style: const TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF333333))),
                      ],
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 20),
              // 莉翫☆縺・蝠上・繧ｿ繝ｳ
              GestureDetector(
                onTap: () {
                  showDialog(
                    context: context,
                    builder: (context) => Dialog(
                      child: Container(
                        padding: const EdgeInsets.all(24),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            const Text(
                              '繧ｫ繝・ざ繝ｪ繧帝∈謚・,
                              style: TextStyle(
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                  color: Color(0xFF333333)),
                            ),
                            const SizedBox(height: 20),
                            _buildCategoryButton('蜊倩ｪ・, 'vocabulary', 5),
                            const SizedBox(height: 12),
                            _buildCategoryButton('譁・ｳ・, 'grammar', 2),
                            const SizedBox(height: 12),
                            _buildCategoryButton('隱ｭ隗｣', 'reading', 2),
                          ],
                        ),
                      ),
                    ),
                  );
                },
                child: Container(
                  margin: const EdgeInsets.symmetric(horizontal: 20),
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      colors: [Color(0xFF5DADE2), Color(0xFF3498DB)],
                    ),
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.blue.withOpacity(0.3),
                        blurRadius: 12,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: const [
                      Icon(Icons.flash_on, color: Colors.white, size: 28),
                      SizedBox(width: 12),
                      Text(
                        '莉翫☆縺・蝠・,
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
